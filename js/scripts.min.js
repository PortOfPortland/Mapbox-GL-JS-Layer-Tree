"use strict";function LayerTree(a){this.options=a,this.collection=[]}function findLayerIndex(a,b,c){for(var d=-1,e=a.length-1;e>=0;e--)if("object"==typeof b[c]&&null!==b[c]){if(a[e].id===b[c].id){d=e;break}}else if(a[e].id===b[c]){d=e;break}return d}LayerTree.prototype.onAdd=function(a){this._map=a,this._container=document.createElement("div"),this._container.className="mapboxgl-ctrl mapboxgl-ctrl-group";var b=document.createElement("div");b.className="mapboxgl-ctrl legend-container";var c=document.createElement("div");return c.id="mapboxgl-legend",b.appendChild(c),this._container.appendChild(b),this.getLayers(a),this._container},LayerTree.prototype.onRemove=function(){this._container.parentNode.removeChild(this._container),this._map=void 0},LayerTree.prototype.getLayers=function(a){var b=this,c=b.options.layers,d=b.collection;a.collection=d,a.lyrs=c,a.on("sourcedataloading",function(e){var f=c.filter(function(a){return a.source===e.sourceId});if(f[0]){var g=a.getSource(e.sourceId);d.push(g),b.appendLayerToLegend(a,g,f[0])}d.length===c.length&&b.enableSortHandler(a,b.loadComplete(b,a,d))})},LayerTree.prototype.appendLayerToLegend=function(a,b,c){var d="#mapboxgl-legend",e=c.directory,f=e.replace(/\s+/g,"-").toLowerCase(),g=c.name,h=c.source,i="<div id='"+h+"' class='layer-item grb'><input class='toggle-layer' type='checkbox'><span class='name'>"+g+"</span></div>";$("#"+f).length?$("#"+f).append(i):($(d).append("<div id='"+f+"' class='layer-directory grb'><div class='directory-name'>"+e+"<i class='fa toggle-directory-open' aria-hidden='true'</i></div></div>"),$("#"+f).append(i))},LayerTree.prototype.loadBasemaps=function(a,b){for(var c="#mapboxgl-legend",d=b.length-1;d>=0;d--){var e=b[d].directory,f=e.replace(/\s+/g,"-").toLowerCase(),g=b[d].name,h=b[d].id,i=b[d].source,j="<div id='"+h+"' class='layer-item grb'><input class='toggle-basemap' type='radio' base-style='"+i+"'><span class='name'>"+g+"</span></div>";$("#"+f).length?$("#"+f).append(j):($(c).append("<div id='"+f+"' class='layer-directory grb'><div class='directory-name'>"+e+"</div></div>"),$("#"+f).append(j));var k=b[d].source.replace("mapbox://styles","");a.style.stylesheet.sprite.indexOf(k)>-1&&$("#"+h+" input").prop("checked",!0),$("body").on("click",".toggle-basemap",function(){var a=$(this).parent().attr("id"),b=$("#"+a+" input[type=radio]");$(".toggle-basemap").prop("checked",!1),b.prop("checked",!0)})}},LayerTree.prototype.updateLegend=function(a,b,c){function l(a,b){a.sort(function(a,b){var c=parseInt(a.getAttribute("initial-index")),d=parseInt(b.getAttribute("initial-index"));return d-c}),a.detach().appendTo(b)}function m(a){var b=a.getLayoutProperty(g,"visibility");"none"!==b&&$(h+" input").prop("checked",!0)}function n(a,b,c,d){var e=$.grep(c,function(a){return b===a.source});if(e.length){var f=a.getLayer(b),g=a.getSource(b);if(e[0].hasOwnProperty("icon")){var l="<img src='"+e[0].icon+"' alt='"+e[0].id+"'>";$(d+" span.name").before(l)}else{if("fill"===f.type&&"geojson"===g.type)var h=a.getPaintProperty(b,"fill-color")||"",i=a.getPaintProperty(b,"fill-opacity")||"",j="<i class='fa geojson-polygon' aria-hidden='true' style='color:"+h+";opacity:"+i+";'></i>";else if("line"===f.type&&"geojson"===g.type){var k=a.getPaintProperty(b,"line-color")||"";if(a.getPaintProperty(b,"line-dasharray"))var j="<i class='fa geojson-line-dashed' aria-hidden='true' style='color:"+k+";'></i>";else var j="<i class='fa geojson-line-solid' aria-hidden='true' style='color:"+k+";'></i>"}$(d+" span.name").before(j)}}}function o(){var a=$(".layer-directory"),b=$("#mapboxgl-legend");$.each(a,function(a){var b=$(this).children(".layer-item:first"),c=10*b.attr("initial-index");$(this).attr("initial-index",c)}),l(a,b)}for(var d=a.getStyle().layers,f=b.length-1;f>=0;f--){var g=b[f].id,h="#"+g,i=$(h).parent(".layer-directory"),j=i.children(".layer-item"),k=findLayerIndex(d,b,f);$(h).attr("initial-index",k),l(j,i),m(a,g,h),n(a,g,c,h)}$("body").on("click",".toggle-layer",function(){var b=$(this).parent().attr("id");$(this).is(":checked")?(a.setLayoutProperty(b,"visibility","visible"),a.on("render",function(){if(a.loaded()&&"visbile"===a.getLayoutProperty(b,"visibility")){var c=a.queryRenderedFeatures({layers:[b]});void 0===c||0===c.length?$("#"+b).addClass("ghost"):$("#"+b).removeClass("ghost")}})):a.setLayoutProperty(b,"visibility","none")}),$(".directory-name").click(function(){$(this).parent().find(".layer-item").toggle(),$(this).find("i").toggleClass("toggle-directory-open toggle-directory-close")}),o()},LayerTree.prototype.enableSortHandler=function(a){$("#mapboxgl-legend").sortable({items:".layer-directory",stop:function(b,c){for(var f=(a.getStyle().layers,c.item.parent().sortable("toArray")),g=f.length-2;g>=0;g--)for(var h=f[g],i=$("#"+h).sortable("toArray"),j=i.length-1;j>=0;j--)a.moveLayer(i[j])}}),$(".layer-directory").sortable({items:".layer-item",stop:function(b,c){for(var d=[],e=c.item.parent().sortable("toArray").reverse(),f=a.getStyle().layers,g=e.length-1;g>=0;g--){var h=findLayerIndex(f,e,g);if(h){var i={originalOrder:h,newOrder:g,source:e[g]};d.push(i)}}d.sort(function(b,c){c.newOrder>b.originalOrder?a.moveLayer(b.source,c.source):a.moveLayer(c.source,b.source)})}})},LayerTree.prototype.loadComplete=function(a,b,c){var d=function(e){b.loaded()&&(a.updateLegend(b,c,a.options.layers),$(".mapboxgl-ctrl.legend-container").show(),b.off("render",d))},e=function(a){for(var d=b.lyrs.length-1;d>=0;d--){var e=b.lyrs[d].source;if($("#"+e+" .toggle-layer").prop("checked")){var f=b.queryRenderedFeatures({layers:[e]});void 0===f||0===f.length?$("#"+e).addClass("ghost"):$("#"+e).removeClass("ghost")}}};b.on("render",d),b.on("moveend",e)};